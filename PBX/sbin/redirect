#!/bin/bash
umask 122

CONF="$1"
BIND='REDIRECT'
LIMIT=3

count=0
CFG=''

if (echo "${CONF}" | egrep -q '^[0-9]{7}([0-9]{3})?(\.cfg)?$'); then
  CFG="${CONF}"
  echo "${CFG}" | egrep -q '^[0-9]{7}([^0-9]|$)' && CFG="812${CFG}"
  echo "${CFG}" | egrep -q '[0-9]$' && CFG="${CFG}.cfg"
  CFG="/pbx/auto/${BIND}/${CFG}"
  count=`ls -1 "${CFG}" 2>/dev/null | wc -l`
fi

if [ "$CFG" == "" ] || [ $count -eq 0 ]; then
  CFG1=`find /pbx/auto/${BIND}/ -type f -name "*${CONF}*" | egrep -v '^$'`
  count=`echo -n ${CFG} | wc -l`
  if [ ${count} -gt 1 ]; then
    echo "  Ambiguous \"$1\":"
    echo "${CFG1}"
    exit 0
  fi
  [ ${count} -eq 1 ] && CFG="${CFG1}"

  if [ ${count} -eq 0 ]; then
    count=`grep -Rli "${CONF}" /pbx/auto/${BIND}/ | wc -l`
#    [ ${count} -eq 0 ] && echo "Not found \"${CONF}\" inside configurations" && exit 0
    if [ ${count} -gt 1 ]; then
      echo "  Multiple \"${CONF}\" inside configurations:"
      grep -Rli "${CONF}"/pbx/auto/${BIND}/
      exit 0
    fi
    [ ${count} -eq 1 ] && CFG=`grep -Rli "${CONF}" /pbx/auto/${BIND}/`
  fi
fi

CONF="${CFG}"
#echo ${CONF}

mt=`stat -c '%Y' "${CONF}" 2>/dev/null || echo 0`
f=`readlink -f "${CONF}" | egrep "^/pbx/auto/${BIND}/"`
[ $? -ne 0 ] && exit

echo `date "+%Y.%m.%d %H:%M"`"${SUDO_UID} ${SUDO_USER}: OPEN ${f}" >> /var/log/redirect.log

if [ "$2" != "!" ] && [ "$2" != "!!" ]; then
  nano -kiw -Y "/usr/share/nano/conf.nanorc" -o `dirname ${f}` "${CONF}"
  mt1=`stat -c '%Y' "${CONF}" 2>/dev/null || echo 0`

  if [ "$mt1" -eq "$mt" ]; then
    echo 'Config unchanged'
    exit 0
  fi
fi


f=`readlink -f "${CONF}"`
conf=/pbx/conf/${BIND}/`basename ${f}`
did=`basename ${f} .cfg`

if echo "${did}" | egrep -qv '[0-9]'; then
  echo "ERROR: non-numeric DID \"${did}\""
  exit
fi

echo "[* ${did} ${BIND}] ; Autogenerated from ${f}"
(
 echo "[* ${did} ${BIND}] ; Autogenerated from ${f}"
 echo "CallLimit = 3"
 egrep -vi "^(\s|\t)*(CallLimit|CallLevel)(\s|\t)*=" "${f}"
) | /usr/local/sbin/schema > "${conf}" 2>"${conf}.err"
res=$?

if [ ${res} -eq 0 ]; then
  echo "${conf} OK"
  rm -f "${conf}.err"
  echo `date "+%Y.%m.%d %H:%M"`"${SUDO_UID} ${SUDO_USER}: OK ${f}" >> /var/log/redirect.log
else
  cat "${conf}.err"
  echo `date "+%Y.%m.%d %H:%M"`"${SUDO_UID} ${SUDO_USER}: ERROR [${res}] in config ${f}" >> /var/log/redirect.log
  exit
fi
